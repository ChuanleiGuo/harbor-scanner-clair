version: "3"

services:
  # Acts as Harbor registry, i.e. has TLS and authentication enabled.
  registry:
    image: registry:2
    ports:
      - 5443:5443
    environment:
      REGISTRY_HTTP_ADDR: "0.0.0.0:5443"
      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/cert.pem
      REGISTRY_HTTP_TLS_KEY: /certs/key.pem
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
    volumes:
      - registry-data:/var/lib/registry
      - ./registry/certs:/certs
      - ./registry/auth:/auth

  postgres:
    image: postgres:9.6
    ports:
      - 5432:5432
    volumes:
      - postgres-data:/var/lib/postgresql/data

  clair:
    depends_on:
      - postgres
    image: quay.io/coreos/clair:v2.0.8
    command:
      - -config
      - /config/config.yaml
      - -log-level
      - debug
      - --insecure-tls
    ports:
      - 6060-6061:6060-6061
    volumes:
      - ./clair/config:/config
      - clair-tmp:/tmp

  scanner:
    image: goharbor/harbor-scanner-clair:dev
    ports:
      - 8080:8080
    environment:
      SCANNER_LOG_LEVEL: trace
      SCANNER_API_SERVER_ADDR: ":8080"
      SCANNER_CLAIR_URL: http://clair:6060

volumes:
  registry-data:
  postgres-data:
  clair-tmp:
